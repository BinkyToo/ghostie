<!doctype html>
<html>
    <head>
	<meta charset="UTF-8" />
	<title>Tilemap!</title>
	<script src="phaser.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {
	var game = new Phaser.Game(800, 600, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update, render: render });

	function preload() {
	    game.load.image('background', 'darkrock.png');
	    game.load.tilemap('map', 'collision_test.json', null, Phaser.Tilemap.TILED_JSON);
	    game.load.image('ground_1x1', 'ground_1x1.png');
	    game.load.image('walls_1x2', 'walls_1x2.png');
	    game.load.image('tiles2', 'tiles2.png');
	    game.load.spritesheet('ghost', 'ghost-wavey.png', 40, 80, 8);

	}

	var facing = 'left';
	var jumpTimer = 0;
	var cursors;
	var jumpButton;

	var map;
	var layer;

	function create() {

	    game.physics.startSystem(Phaser.Physics.P2JS);

	    game.stage.backgroundColor = '#2d2d2d';
	    var background = game.add.tileSprite(0, 0, 2000, 600, 'background', 0);

	    map = game.add.tilemap('map');
	    
	    ghost = game.add.sprite(game.world.centerX, game.world.centerY, 'ghost');
	    game.physics.enable(ghost, Phaser.Physics.P2JS);
	    var wave = ghost.animations.add('wave');
	    ghost.animations.play('wave', 25, true);
	    ghost.body.fixedRotation = true;
	    ghost.body.restitution = 0.5;
	    ghost.body.damping = 0.6;

	    map.addTilesetImage('ground_1x1');
	    map.addTilesetImage('walls_1x2');
	    map.addTilesetImage('tiles2');
	    
	    layer = map.createLayer('Tile Layer 1');

	    layer.resizeWorld();

	    //  Set the tiles for collision.
	    //  Do this BEFORE generating the p2 bodies below.
	    map.setCollisionBetween(1, 12);

	    //  Convert the tilemap layer into bodies. Only tiles that collide (see above) are created.
	    //  This call returns an array of body objects which you can perform addition actions on if
	    //  required. There is also a parameter to control optimising the map build.
	    game.physics.p2.convertTilemap(map, layer);

	    game.physics.p2.restitution = 0.5;
	    game.physics.p2.gravity.y = 300;


	    game.camera.follow(ghost);

	    cursors = game.input.keyboard.createCursorKeys();
	    jumpButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

	}

	function update() {

	    ghost.angle = ghost.body.velocity.x / 15
	    //ghost.scale.setTo(1+Math.abs(ghost.body.velocity.x/2000), 1+Math.abs(ghost.body.velocity.y/1000))

	    if (cursors.left.isDown)
	    {
		ghost.scale.x = 1;
		if (ghost.body.velocity.x >= -250) {
		  ghost.body.velocity.x -= 10;
		}
		ghost.body.moveDown(40);

	    }
	    else if (cursors.right.isDown)
	    {
		ghost.scale.x = -1;
		if (ghost.body.velocity.x <= 250) {
		  ghost.body.velocity.x += 10;
		}
		ghost.body.moveDown(40);

	    }

	    else if (cursors.up.isDown)
	    {
		if (ghost.body.velocity.y >= -75) {
		  ghost.body.velocity.y -= 10;
		  }
	    }

	}



	function render() {

	}
    };

    </script>

    </body>
</html>